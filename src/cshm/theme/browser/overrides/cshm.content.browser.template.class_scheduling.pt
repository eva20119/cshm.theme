<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/main_template/macros/master"
    i18n:domain="cshm.content">
<body>


<metal:style fill-slot="style_slot">
</metal:style>
<metal:js fill-slot="javascript_head_slot">
    <script type="text/javascript" src="${portal_url}/++plone++cshm.theme/backend.js"></script>
</metal:js>

<metal:content-core fill-slot="content-core">
<metal:content-core define-macro="content-core"
                    tal:define="toc context/table_of_contents|nothing;">

<h3>排課管理-- ${python:context.getParentNode().title} ${context/title}</h3>

<table>
  <tr class="tr-title">
    <td>科目編號</td>
    <td>科目名稱</td>
    <td>教室</td>
    <td>講師</td>
    <td>時數</td>
    <td>排課</td>
    <td>確認/更新</td>
  </tr>

<div>
  <p>開課單位: ${context/trainingCenter/to_object/title}</p>
  <p>批次設定教室:
          <select id='select-classroom'>
            <tal:item repeat="item python:context.trainingCenter.to_object.getChildNodes()">
              <option value="${item/UID}">${item/title}</option>
            </tal:item>
          </select>

  </p>
  <p>新增一列排課:
          <select class='add-scheduling'>
            <tal:item repeat="item python:context.getChildNodes()">
              <option value="${item/UID}">${item/title}</option>
            </tal:item>
          </select>
          <input type="button" class="add-scheduling" value="新增">
  </p>

</div>


  <tal:scheduling repeat="item python:context.getChildNodes()">
    <tal:uid define="sqlResult python:view.alreadyScheduling(item.UID())"
             switch="python:sqlResult">
      <tr class="tr-body not-schedule" tal:case="python:[]" tal:attributes="id python:'tr-%s' % item.UID()">
        <td>${item/id/upper}</td>
        <td>${item/title}</td>
        <td>
          <select name="classroom" id='classroom-${item/UID}'>
            <tal:classroom repeat="classroom python:context.trainingCenter.to_object.getChildNodes()">
              <option class="${classroom/UID}" value="${classroom/UID}">${classroom/title}</option>
            </tal:classroom>
          </select>
        </td>
        <td tal:content="item/teacher/to_object/title | nothing">講師</td>
        <td>${item/hours}</td>
        <td>
          日期:
          <input placeholder="格式: 107/2/12" name="year" style="width:100px" id="date-${item/UID}">
          起: <input placeholder="格式: 1800" style="width:100px" id="start-${item/UID}">
          迄: <input placeholder="格式: 2100" style="width:100px" id="end-${item/UID}">
        </td>
        <td>
          <a tal:condition="not:item/ignoreSchedule" class="update" data-uid="${item/UID}" href="javascript:voild(0)">更新</a>
          <span tal:condition="item/ignoreSchedule">不用排課</span>
        </td>
      </tr>

      <tal:notempty case="python:default">
        <tr class="tr-body scheduled" tal:repeat="record python:sqlResult" tal:attributes="id python:'tr-%s' % record['id']">
          <td>${item/id/upper}</td>
          <td>${item/title}</td>

          <td>    
            <select name="classroom" id='classroom-${record/id}'>
              <tal:item repeat="classroom python:context.trainingCenter.to_object.getChildNodes()">
                <option value="${classroom/UID}"
                        tal:attributes="selected python:True if record['classroom'].split('-')[1] == classroom.id else False">${classroom/title}
                </option>
              </tal:item>
            </select>
          </td>



          <td tal:content="item/teacher/to_object/title | nothing">講師</td>
          <td>${item/hours}</td>
          <td>
            日期:
            <input placeholder="格式: 107/2/12" name="year" style="width:100px"
                   value="${python:record['start'].year-1911}/${python:record['start'].strftime('%-m/%-d')}"
                   id="date-${record/id}">
            起: <input placeholder="格式: 1800" style="width:100px"
                       value="${python:record['start'].strftime('%H%M')}"
                       id="start-${record/id}">
            迄: <input placeholder="格式: 2100" style="width:100px"
                       value="${python:record['end'].strftime('%H%M')}"
                       id="end-${record/id}">
          </td>
          <td>
            <a class="update" data-uid="${record/id}" href="javascript:voild(0)">更新</a>
          </td>
        </tr>
      </tal:notempty>



    </tal:uid>
  </tal:scheduling>
</table>

<script>
$(document).ready(function(){
    $('a.update').click(function(){
        uid = $(this).data('uid')
//alert(uid)

        data = {uid: uid,
                date: $('#date-' + uid).val(),
                start: $('#start-' + uid).val(),
                end: $('#end-' + uid).val(),
                update_class_scheduling: true,
                classroom: $('#classroom-' + uid).val()
               }
//debugger
//alert($('#classroom-' + uid).val())
        $.post('${context/absolute_url}/@@class_scheduling',
            data=data,
        ).done(function(data){
            if(data.split(':')[0] == 'overtime'){
                $('#' + data.split(':')[1]).css('background', '#e77')
                alert('時間衝突')
                return
            }
            $('#tr-' + uid).css('background', '#8c8')
            alert(data)
          }
        ).fail(function(){
            alert('更新失敗，請稍候再試，若一直失敗，請聯絡系統管理員')
        })

    })


    /* 批次選教室 */
    $('#select-classroom').change(function(){
        uid = $(this).val()
        $('.not-schedule option').attr('selected', false)
        $('.not-schedule .' + uid).attr('selected', true)
    })

    /* 新增一列 */
    $('input.add-scheduling').click(function(){
        uid = $('select.add-scheduling').val()
    })

})
</script>




<script>
var app = new Vue({
    el: '#content-core',
    data: {
      message: 'Hello Vue!'
    },
    methods: {
    }
})
</script>

</metal:content-core>
</metal:content-core>

</body>
</html>
